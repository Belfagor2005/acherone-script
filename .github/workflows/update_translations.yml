name: Update Translations

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "**/*.py"
      - "**/*.xml"
      - "**/locale/**"
  schedule:
    - cron: "0 0 * * 0"   # ogni domenica

jobs:
  update-translations:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup translation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gettext python3-lxml

      - name: Verify main script exists
        run: |
          echo "ğŸ“ Checking for update_all_plugins.py..."
          if [ -f "update_all_plugins.py" ]; then
            echo "âœ… Found: update_all_plugins.py"
            ls -la update_all_plugins.py
          else
            echo "âŒ ERROR: update_all_plugins.py not found!"
            echo "Current directory: $(pwd)"
            echo "Files:"
            ls -la
            exit 1
          fi

      - name: Run translation updater
        run: |
          echo "ğŸš€ Running update_all_plugins.py..."
          python3 update_all_plugins.py

      - name: Show results
        run: |
          if [ -f "translation_update_report.json" ]; then
            echo "ğŸ“Š Translation Update Results:"
            python3 << 'EOF'
import json

try:
    with open('translation_update_report.json', 'r') as f:
        data = json.load(f)
except json.JSONDecodeError as e:
    print(f"âŒ JSON ERROR: {e}")
    exit(1)

print(f"Plugins processed: {data.get('total_plugins', 0)}")
print(f"Successful: {data.get('successful', 0)}")
print(f"Failed: {data.get('failed', 0)}")

for detail in data.get('details', []):
    status = "âœ…" if detail.get('success') else "âŒ"
    plugin_name = detail.get('plugin_name', 'unknown')
    new_strings = detail.get('new_strings', 0)
    print(f"{status} {plugin_name}: {new_strings} new strings")
EOF
          else
            echo "âš ï¸ No translation report generated"
          fi

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          if git diff --name-only | grep -E '\.(po|mo|pot|json)$' > /dev/null; then
            echo "ğŸ“ Found translation changes, committing..."
            git add --all
            git commit -m "ğŸŒ Update translations [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push
          else
            echo "âœ… No translation files changed"
